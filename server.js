const express=require("express"),{createClient:e}=require("@supabase/supabase-js"),cors=require("cors"),jwt=require("jsonwebtoken"),axios=require("axios"),app=express(),SUPABASE_URL="https://vollcwutsgcomenxdamh.supabase.co",SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvbGxjd3V0c2djb21lbnhkYW1oIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTcwNDIxNiwiZXhwIjoyMDc3MjgwMjE2fQ.8gm4hQGZ2p9_kUkvaRettQCmJAj6eAwt1QBKQP05MdY",JWT_SECRET="darling-secret-2024",PAYSTACK_SECRET="sk_test_fcd9fd5b233ad2f7f7cc7303d792d77deb0dabb9",PORT=process.env.PORT||3001,supabase=e(SUPABASE_URL,SUPABASE_KEY),auth=(e,s,r)=>{try{const a=e.headers.authorization?.split(" ")[1];if(!a)return s.status(401).json({error:"No token"});const t=jwt.verify(a,JWT_SECRET);e.userId=t.userId,r()}catch(e){s.status(401).json({error:"Invalid token"})}};app.use(cors()),app.use(express.json()),app.get("/",(e,s)=>{s.json({service:"Darling Dating App API",status:"LIVE",version:"1.0.0",payment:"Paystack ZAR"})}),app.get("/api/health",async(e,s)=>{const{count:r}=await supabase.from("users").select("*",{count:"exact",head:!0});s.json({status:"ok",database:"connected",users:r||0})}),app.post("/api/auth/signup",async(e,s)=>{const{email:r,password:a,name:t,age:n,gender:i}=e.body;if(n<18)return s.status(400).json({error:"Must be 18+"});const{data:u,error:o}=await supabase.auth.signUp({email:r,password:a});if(o)return s.status(400).json({error:o.message});const{data:c}=await supabase.from("users").insert([{id:u.user.id,email:r,name:t,age:n,gender:i,subscription_tier:"free"}]).select().single();await supabase.from("coins").insert([{user_id:u.user.id,balance:0}]);const p=jwt.sign({userId:u.user.id,email:r},JWT_SECRET,{expiresIn:"7d"});s.status(201).json({message:"Signup successful",user:c,token:p})}),app.post("/api/auth/login",async(e,s)=>{const{email:r,password:a}=e.body,{data:t,error:n}=await supabase.auth.signInWithPassword({email:r,password:a});if(n)return s.status(401).json({error:"Invalid credentials"});const{data:i}=await supabase.from("users").select("*").eq("id",t.user.id).single(),u=jwt.sign({userId:t.user.id,email:r},JWT_SECRET,{expiresIn:"7d"});s.json({message:"Login successful",user:i,token:u})}),app.post("/api/swipes/create",auth,async(e,s)=>{const{targetUserId:r,action:a}=e.body;if(await supabase.from("swipes").insert([{user_id:e.userId,target_user_id:r,action:a}]),"like"===a){const{data:a}=await supabase.from("swipes").select("*").eq("user_id",r).eq("target_user_id",e.userId).eq("action","like").single();if(a)return await supabase.from("matches").insert([{user_1_id:e.userId,user_2_id:r}]),s.status(201).json({message:"Match!",matched:!0})}s.status(201).json({message:"Swipe recorded",action:a})}),app.get("/api/swipes/feed",auth,async(e,s)=>{const{data:r}=await supabase.from("users").select("id,name,age,gender").neq("id",e.userId).limit(10);s.json({candidates:r||[]})}),app.get("/api/swipes/matches",auth,async(e,s)=>{const{data:r}=await supabase.from("matches").select("*").or(`user_1_id.eq.${e.userId},user_2_id.eq.${e.userId}`);s.json({matches:r||[]})}),app.post("/api/messages/send",auth,async(e,s)=>{const{matchId:r,text:a}=e.body,{data:t}=await supabase.from("messages").insert([{match_id:r,sender_id:e.userId,text:a}]).select().single();s.status(201).json({message:"Sent",data:t})}),app.get("/api/messages/:matchId",auth,async(e,s)=>{const{data:r}=await supabase.from("messages").select("*").eq("match_id",e.params.matchId).order("created_at");s.json({messages:r||[]})}),app.get("/api/subscriptions/me",auth,async(e,s)=>{const{data:r}=await supabase.from("users").select("subscription_tier").eq("id",e.userId).single();s.json({tier:r.subscription_tier})}),app.get("/api/coins/balance",auth,async(e,s)=>{const{data:r}=await supabase.from("coins").select("balance").eq("user_id",e.userId).single();s.json({balance:r?.balance||0})}),app.get("/api/profile/me",auth,async(e,s)=>{const{data:r}=await supabase.from("users").select("*").eq("id",e.userId).single();s.json({profile:r})}),app.post("/api/payments/paystack/initialize",auth,async(e,s)=>{const{email:r,amount:a,tier:t}=e.body,n=await axios.post("https://api.paystack.co/transaction/initialize",{email:r,amount:100*a,currency:"ZAR",metadata:{user_id:e.userId,tier:t}},{headers:{Authorization:`Bearer ${PAYSTACK_SECRET}`}});s.json({authorization_url:n.data.data.authorization_url,reference:n.data.data.reference})}),app.post("/api/payments/paystack/verify",async(e,s)=>{const{reference:r}=e.body,a=await axios.get(`https://api.paystack.co/transaction/verify/${r}`,{headers:{Authorization:`Bearer ${PAYSTACK_SECRET}`}});if("success"===a.data.data.status){const{user_id:e,tier:s}=a.data.data.metadata;return await supabase.from("users").update({subscription_tier:s}).eq("id",e),await supabase.from("payments").insert([{user_id:e,reference:r,amount:a.data.data.amount/100,status:"completed"}]),s.json({message:"Payment verified",tier:s})}s.json({status:"failed"})}),app.listen(PORT,()=>{console.log(`\nðŸŽ€ Darling Backend LIVE on ${PORT}`),console.log("âœ… Database: Connected"),console.log("âœ… Paystack: Configured\n")});
